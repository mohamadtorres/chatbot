<!DOCTYPE html>
<html lang="en">
<head>
<!-- Markdown-it (For Markdown Parsing) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/12.3.2/markdown-it.min.js"></script>

<!-- Highlight.js (For Code Syntax Highlighting) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- KaTeX (For Math Rendering) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.3/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.3/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.3/contrib/auto-render.min.js"></script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwecoDeep</title>
    
    <link rel="stylesheet" href="static\styles\style.css">

</head>
<body>
    {% load static %}
    <div class="header">
        <img src="{% static 'images/sweco_logo1.png' %}" alt="Sweco Logo">
        <h1>SwecoDeep</h1>
    </div>

    <div class="container">
        
        <div class="sidebar">
            <a href="/">+ New chat</a>
            <a href="#">Recent chats</a>
            <div class="bottom-links">
                <!-- Privacy Button -->
                    <a href="#" onclick="openModal('privacyModal')">
                        Privacy <span class="info-icon">â“˜</span>
                    </a>
                
                    <!-- Help Button -->
                    <a href="#" onclick="openModal('helpModal')">
                        Help <span class="info-icon">â“˜</span>
                    </a>
            </div>
        </div>
        
        <!-- Privacy Modal -->
        <div id="privacyModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('privacyModal')">&times;</span>
                <h2>Privacy Policy</h2>
                <h3>1. Introduction:</h3>
                    <p>At Sweco, we take your privacy seriously. This Privacy Notice explains how we collect, use, and protect your personal information when you interact with SwecoDeep, our AI assistant. We are committed to ensuring that your personal information is protected and handled in accordance with applicable data protection laws.</p>
                    
                    <h3>2. Information We Collect:</h3>
                    <p>SwecoDeep may collect and process personal information provided by you during the course of your interaction with SwecoDeep. This may include your name, contact details, and any other information you choose to share.</p>
                    
                    <h3>3. Use of Personal Information:</h3>
                    
                    <li>To provide you with accurate and relevant responses to your queries or requests.<br></li>
                    <li>To improve our AI assistant's functionality and performance.<br>
                    <li>To conduct data analysis and research to enhance our services.<br></li>
                    <li>To comply with legal obligations and respond to lawful requests.<br></li>
                    <li>To increase usage of AI at Sweco</li><br>
                    <h3>4. Data Sharing and Disclosure:</h3>
                    <p>We do not share or disclose your personal information collected by SwecoDeep to third parties unless required by law or with your explicit consent.</p>
                    
                    <h3>5. Data Security:</h3>
                    <p>We have implemented appropriate technical and organizational measures to safeguard your personal information against unauthorized access, loss, or alteration. However, please note that no method of transmission over the internet or electronic storage is 100% secure.</p>
                    
                    <h3>6. Retention of Personal Information:</h3>
                    <p>We will retain your personal information collected by SwecoDeep only for as long as necessary to fulfill the purposes outlined in this Privacy Notice, unless a longer retention period is required or permitted by law.</p>
                    
                    <h3>7. Your Rights:</h3>
                    <p>You have certain rights regarding your personal information, including the right to access, correct, or delete your personal information. If you have any questions or wish to exercise your rights, please contact us using the contact information provided below.</p>
                    
                    <h3>8. Changes to this Privacy Notice:</h3>
                    <p>We may update this Privacy Notice from time to time to reflect changes in our practices or legal requirements. We encourage you to review this Privacy Notice periodically.</p>
                    <h3>Contact Us:
                    <p>If you have any questions, concerns, or requests regarding this Privacy Notice or the processing of your personal information by SwecoDeep, please contact your Local Privacy Officer</p>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('helpModal')">&times;</span>
                <h2>Help</h2>
                <b>SwecoDeep</b> is an advanced AI capable of understanding and generating human-like text. Use it for tasks such as drafting emails, creating content, and answering questions. Please use this service in an ethical way. Do not share confidential information from Sweco, clients or other parties without consent from the information owner. Respect the privacy of others in accordance with Sweco's privacy policies and procedures. It is for example not allowed to use the service to process sensitive client data, HR data or other sensitive data about employees. It's proficient in many topics, but its knowledge is based on information available up until April 2023. Limitations include inability to access real-time data, understand new events post-training, and provide personal advice. SwecoDeep may occasionally generate incorrect or outdated information. It learns from a broad array of sources, some of which may contain inaccuracies. It can't validate or fact-check information in real-time. Always cross-verify critical information from trusted sources and apply your judgment when using AI-generated content.<br>
                <br>
                For guidance information regarding AI usage at Sweco refer to the AI Usage Procedure.<br>
                
                <h3>SwecoDeep Document Storage Instructions</h3>
                1. Users can upload a maximum of 100 MB per folder.<br>
                
                2. Each user can have 5 folders.<br>

                3. Only copies of documents should be uploaded. Users should always keep an original version on a separate storage.<br>
                
                4. Documents should only be uploaded for the intended purpose of SwecoDeep. The intended purpose is to use GPT prompts regularly on the document contents.<br>
                
                5. If a folder has not been activated for 45 days, an email will be sent to the user that the folder and contents will be deleted in 30 days, a reminder email will be sent after 10 more days if it is not activated or deleted, a reminder email will be sent after 10 further days if it is not activated or deleted, a final reminder email will be sent 7 days after with final warning of deletion in 3 days time.<br>
                
                6. The folder will be unindexed and then native files archived for 30 further days and then deleted, after this the documents will be unrecoverable.<br>
                
                7. The policy is the same for shared folders.
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-box" id="chatbox">
            </div>
            <div class="input-area">
                <textarea id="userInput" placeholder="Enter a prompt here ..." onkeydown="handleKeyPress(event)"></textarea>
                <button onclick="sendMessage()" id="sendButton">
                    &#8593; <!-- Unicode for a small UP arrow -->
                </button>
            </div>
        </div>
        <script>
            async function sendMessage() {
            let userInput = document.getElementById("userInput").value;
            let chatbox = document.getElementById("chatbox");

            if (userInput.trim() === "") return; // Prevent empty messages

            // âœ… Display user message instantly
            chatbox.innerHTML += `<div class="user-message">${userInput}</div>`;
            document.getElementById("userInput").value = "";
            chatbox.scrollTop = chatbox.scrollHeight;

            // âœ… Create a separate bot message container for this response
            let botMessageContainer = document.createElement("div");
            botMessageContainer.classList.add("bot-message");

            // âœ… Create a streaming placeholder (so each message is unique)
            let streamingMessage = document.createElement("span");
            streamingMessage.innerHTML = "ðŸ¤–: <em>Thinking...</em>"; // âœ… Show "Thinking..." before response
            botMessageContainer.appendChild(streamingMessage);

            chatbox.appendChild(botMessageContainer); // âœ… Append new message container

            try {
                // âœ… Step 1: Fetch Full Response (Hidden from user)
                let response = await fetch("/chatbot/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: userInput })
                });

                let responseData = await response.json();
                let fullMessage = responseData.reply || "";
                let thoughtProcess = responseData.thought || "";

                // âœ… Step 2: Format the Full Response (Markdown, Math, Code Highlighting)
                let formattedMessage = marked.parse(fullMessage); // âœ… Convert Markdown to HTML

                // âœ… Apply Syntax Highlighting (for code blocks)
                let tempDiv = document.createElement("div");
                tempDiv.innerHTML = formattedMessage;
                tempDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

                // âœ… Apply KaTeX for Math Equations
                renderMathInElement(tempDiv, {
                    delimiters: [
                        { left: "$$", right: "$$", display: true },  // Block math
                        { left: "$", right: "$", display: false },  // Inline math
                        { left: "\\(", right: "\\)", display: false },  // Inline math
                        { left: "\\[", right: "\\]", display: true }   // Block math
                    ]
                });

                // âœ… Get final formatted HTML (without replacing previous messages)
                let finalMessage = tempDiv.innerHTML;

                // âœ… Step 3: Replace "Thinking..." with the actual response (Simulated Typing)
                await simulateStreaming(streamingMessage, finalMessage);

                // âœ… Step 4: Append Thought Process (if available)
                if (thoughtProcess) {
                    let thoughtContainer = document.createElement("div");
                    thoughtContainer.classList.add("thought-container");
                    thoughtContainer.innerHTML = `
                        <button class="toggle-thought" onclick="toggleThought(this)" title="Show Thought Process">
                            Show thought process
                        </button>
                        <div class="thought-content" style="display: none;">
                            <p><strong>Chatbot Thought Process:</strong></p>
                            <p>${thoughtProcess}</p>
                        </div>
                    `;
                    chatbox.appendChild(thoughtContainer);
                }

            } catch (error) {
                console.error("Error:", error);
                streamingMessage.innerHTML = `<p>Error: Unable to contact chatbot.</p>`;
            }
        }

        // âœ… Simulated streaming effect AFTER response is fully generated
        async function simulateStreaming(element, formattedText) {
            let words = formattedText.split(" ");
            let displayedMessage = "ðŸ¤–: ";

            for (let word of words) {
                displayedMessage += word + " ";
                element.innerHTML = displayedMessage;
                chatbox.scrollTop = chatbox.scrollHeight; // Auto-scroll
                await new Promise(resolve => setTimeout(resolve, 50)); // âœ… Typing delay
            }
        }

            function toggleThought(button) {
                let content = button.nextElementSibling;
                
                if (content.style.display === "none") {
                    content.style.display = "block"; // Show thought process
                    button.innerHTML = "&#9650;"; // Change arrow to up (â¬†)
                    button.title = "Hide Thought Process"; // Change tooltip
                } else {
                    content.style.display = "none"; // Hide thought process
                    button.innerHTML = "&#9660;"; // Change arrow back to down (â¬‡)
                    button.title = "Show Thought Process"; // Reset tooltip
                }
            }

            function handleKeyPress(event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            }

            function formatresponse(response) {
                if (!response) return "";

                const md = window.markdownit(); // Initialize Markdown-it
                let formattedResponse = md.render(response); // Convert Markdown to HTML

                // âœ… Ensure KaTeX renders properly, including `\boxed{}`
                formattedResponse = formattedResponse
                    .replace(/\$\$(.*?)\$\$/gs, "<span class='math-block'>$$$1$$</span>") // Block Math
                    .replace(/\$(.*?)\$/g, "<span class='math-inline'>$1</span>") // Inline Math
                    .replace(/\\\[(.*?)\\\]/g, "\\[$1\\]") // Preserve Block Math
                    .replace(/\\\((.*?)\\\)/g, "\\($1\\)"); // Preserve Inline Math

                console.log("Formatted Response Before Fix:", formattedResponse); // Debugging

                // âœ… Wrap all `<pre><code>` blocks with a copy button
                formattedResponse = formattedResponse.replace(
                    /<pre><code class="(.*?)">(.*?)<\/code><\/pre>/gs,
                    (match, lang, code) => `
                        <div class="code-container">
                            <div class="code-header">
                                <span class="language-label">${lang || "Code"}</span>
                                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                            </div>
                            <pre><code class="${lang}">${code}</code></pre>
                        </div>
                    `
                );

                console.log("Formatted Response After Fix:", formattedResponse); // Debugging

                // âœ… Ensure Markdown, Syntax Highlighting & KaTeX Work After Rendering
                setTimeout(() => {
                    document.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });

                    // âœ… Apply KaTeX Rendering to New Content
                    renderMathInElement(document.getElementById("chatbox"), {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },  // Block math
                            { left: "$", right: "$", display: false },  // Inline math
                            { left: "\\(", right: "\\)", display: false },  // Inline math alternative
                            { left: "\\[", right: "\\]", display: true }   // Block math alternative
                        ],
                        throwOnError: false, // âœ… Prevent crashes on math errors
                    });
                }, 50);

                return formattedResponse;
            }





            function copyCode(button) {
                let codeBlock = button.parentElement.nextElementSibling.querySelector("code");
                let textArea = document.createElement("textarea");
                textArea.value = codeBlock.innerText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);

                // âœ… Change button text temporarily to "Copied!"
                button.innerText = "Copied!";
                setTimeout(() => button.innerText = "Copy", 2000);
            }





            // Function to open the modal when the user clicks
            function openModal(modalId) {
                let modal = document.getElementById(modalId);
                modal.style.display = "flex"; // âœ… Fix: Ensures proper alignment in the center
            }

            // Function to close the modal when clicking "X"
            function closeModal(modalId) {
                let modal = document.getElementById(modalId);
                modal.style.display = "none";
            }

            // âœ… Close modal when clicking outside of it
            window.onclick = function(event) {
                let modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
            modal.style.display = "none";
                    }
                });
            };






        </script>
        
        
        

    </div>

    <div class="footer">
        &copy; 2025 Designed by Sweco based on a <span style="color: #4d6bfe;">DeepSeek</span> model <!--To have the deepseek word in blue like the real deepseek-->
    </div>

</body>
</html>
