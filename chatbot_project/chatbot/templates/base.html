<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Prism.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwecoDeep</title>
    <script type="text/javascript" id="MathJax-script" async 
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>
    
    <link rel="stylesheet" href="static\styles\style.css">

</head>
<body>
    {% load static %}
    <div class="header">
        <img src="{% static 'images/sweco_logo.png' %}" alt="Sweco Logo">
        <h1>SwecoDeep</h1>
    </div>

    <div class="container">
        
        <div class="sidebar">
            <h3>Menu</h3>
            <a href="#">Home</a>
            <a href="#">Recent chats</a>
            <hr>
            
            <!-- Privacy Button -->
            <a href="#" onclick="openModal('privacyModal')">
                Privacy <span class="info-icon">â“˜</span>
            </a>
        
            <!-- Help Button -->
            <a href="#" onclick="openModal('helpModal')">
                Help <span class="info-icon">â“˜</span>
            </a>
        </div>
        
        <!-- Privacy Modal -->
        <div id="privacyModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('privacyModal')">&times;</span>
                <h2>Privacy Policy</h2>
                <p>Your privacy is important. We do not store or share your chat data.</p>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('helpModal')">&times;</span>
                <h2>Help</h2>
                <p>If you have any issues, please contact support or refer to our documentation.</p>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-box" id="chatbox">
                <!-- Chat messages will appear here... -->
            </div>
            <div class="input-area">
                <textarea id="userInput" placeholder="Type a message..." onkeydown="handleKeyPress(event)"></textarea>
                <button onclick="sendMessage()" id="sendButton">
                    &#9658; <!-- Unicode for a small right arrow -->
                </button>
            </div>
        </div>
        <script>
            function sendMessage() {
                let userInput = document.getElementById("userInput").value;
                let chatbox = document.getElementById("chatbox");

                if (userInput.trim() === "") return;

                chatbox.innerHTML += `<div class="user-message">${userInput}</div>`;
                document.getElementById("userInput").value = "";
                chatbox.scrollTop = chatbox.scrollHeight;

                fetch("/chatbot/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: userInput })
                })
                .then(response => response.json())
                .then(data => {
                    if ("reply" in data) {
                        let botMessage = formatresponse(data.reply);
                        let thoughtProcess = data.thought;

                        let thoughtHtml = `
                            <div class="thought-container">
                                <button class="toggle-thought" onclick="toggleThought(this)">Show Thought Process</button>
                                <div class="thought-content" style="display: none;">
                                    <p><strong>Chatbot Thought Process:</strong></p>
                                    <p>${thoughtProcess}</p>
                                </div>
                            </div>
                        `;

                        chatbox.innerHTML += `<div class="bot-message">ðŸ¤–: ${botMessage}</div>` + thoughtHtml;

                        
                        setTimeout(() => {
                            Prism.highlightAll();
                            MathJax.typeset(); 
                        }, 50);
                    } else {
                        chatbox.innerHTML += `<p class="bot-message">ChatBot: Error: No response received.</p>`;
                    }

                    chatbox.scrollTop = chatbox.scrollHeight;
                })
                .catch(error => {
                    console.error("Error:", error);
                    chatbox.innerHTML += `<p class="bot-message">Error: Unable to contact chatbot.</p>`;

                });
            }
        
            function toggleThought(button) {
                let content = button.nextElementSibling;
                if (content.style.display === "none") {
                    content.style.display = "block";
                    button.textContent = "Hide Thought Process";
                } else {
                    content.style.display = "none";
                    button.textContent = "Show Thought Process";
                }
            }

            function handleKeyPress(event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            }
            function formatresponse(response) {
                if (!response) return "";

                // Convert `\n` to `<br>` for paragraph separation
                response = response.replace(/\n/g, "<br>");

                // Convert **bold text** to `<strong>bold text</strong>`
                response = response.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

                // Convert __italic text__ to `<em>italic text</em>`
                response = response.replace(/__(.*?)__/g, "<em>$1</em>");

                // Convert `- lists` into `<ul><li>` format
                response = response.replace(/- (.*?)(<br>|$)/g, "<li>$1</li>");
                response = response.replace(/(<li>.*<\/li>)+/g, "<ul>$&</ul>"); // Wrap lists in <ul>

                // Convert links (URLs) into clickable `<a>` elements
                response = response.replace(/(https?:\/\/[^\s]+)/g, "<a href='$1' target='_blank'>$1</a>");

                // âœ… Convert inline code (`code`) into `<code>code</code>`
                response = response.replace(/`([^`]+?)`/g, "<code>$1</code>");

                // âœ… **Fix: Normalize Multi-line Code Blocks**
                response = response.replace(/``?(\w*)\n([\s\S]*?)(?:`{1,2}|$)/g, function(match, lang, code) {
                    let languageClass = lang ? `language-${lang}` : "language-python"; // Default to Python

                    return `
                        <div class="code-container">
                            <div class="code-header">
                                <span class="language-label">${languageClass}</span>
                                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                            </div>
                            <pre class="code-block"><code class="${languageClass}">${Prism.highlight(code.trim(), Prism.languages[lang] || Prism.languages.python, lang || 'python')}</code></pre>
                        </div>
                    `;
                });

                return response;
            }

            // âœ… Function to copy code from the box
            function copyCode(button) {
                let codeBlock = button.parentElement.nextElementSibling.querySelector("code");
                let textArea = document.createElement("textarea");
                textArea.value = codeBlock.innerText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
                button.innerText = "Copied!";
                setTimeout(() => button.innerText = "Copy", 2000);
            }


            // Function to open the modal when the user clicks
            function openModal(modalId) {
                let modal = document.getElementById(modalId);
                modal.style.display = "flex"; // âœ… Fix: Ensures proper alignment in the center
            }

            // Function to close the modal when clicking "X"
            function closeModal(modalId) {
                let modal = document.getElementById(modalId);
                modal.style.display = "none";
            }

            // âœ… Close modal when clicking outside of it
            window.onclick = function(event) {
                let modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
            modal.style.display = "none";
                    }
                });
            };






        </script>
        
        
        

    </div>

    <div class="footer">
        &copy; 2025 Designed by Sweco based on a <span style="color: #4d6bfe;">DeepSeek</span> model <!--To have the deepseek word in blue like the real deepseek-->
        <h5>Sweek may produce inaccurate information about people, places, or facts. Please check before using the information.</h5>
    </div>

</body>
</html>
